{% extends "base.html" %}

{% block content %}
    <!-- Afficher le code de la personne Methode GET-->
        <form class="container" method="GET">
            <div class="row">
                <div class="col-12"> <header class="page-header"><h2>Page de modification du registre pour <small class="text-muted"> {{registre_origine.personnes.nom}}, {{registre_origine.personnes.prenom}}</small></h2></header></div>
            </div>
         </form>

 <!-- The Modal -->
       {% include 'includes/modal.html' %}

        <!-- Afficher les chmaps à compléter -->
        <form class="container-fluid form-once-only" method="POST" id="modificationFormId" action="{{url_for("modifier_registre", id_registre=registre_origine.id)}}">

         <!-- Formulaire avec les sources et les commentaires -->

         <div class="card bg-light mb-3" style="max-width: 100rem;">
                  <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#sourcesAndComment" aria-controls="sourcesAndComment">Modifier les sources d'archives</div>
                    <div class="collapse" id="sourcesAndComment">
                         <div class="card card-body ">
                                <div class="form-group required">
                                 <label for="archive">Nom de l'institution de conservation de la source</label>
                                 <input type="text" class="form-control" id="archive" name="archive" value="{{ registre_origine.nomArchive or '' }}">
                                </div>

                               <div class="form-group required">
                                <label for="cote">Cote</label>
                                <input type="text" class="form-control" id="cote" name="cote" value="{{ registre_origine.cote or '' }}">
                               </div>

                               <div class="form-group">
                                <label for="typeDoc">Type du document</label>
                                <input type="text" class="form-control" id="typeDoc" maxlength="64" name="typeDoc" value="{{ registre_origine.natureDoc or '' }}">
                               </div>

                          <div class="form-group">
                            <label for="typeDoc">Collecte réalisée par</label>
                            <input type="text" class="form-control" id="collecte" maxlength="64" name="collecte" value="{{ registre_origine.collecte or '' }}">
                           </div>

                              <div class="containerPhotos" id="containerPhotos">
                                       <label for="photo">Numéro de la photo</label>
                                          {% if registre_origine.photos %}
                                              {% for photo in registre_origine.photos %}
                                           <div class="photo-link-div form-group row">
                                               <div class="col-3">
                                                    <input type="text" class="form-control" id="photo" maxlength="64" name="photo" value="{{ photo.label_photo }}">
                                               </div>
                                               <div class="col-1">
                                                     <div class="input-group-append">
                                                       <button class="btn btn-outline-success add-new-photo font-weight-bold btn-sm" type="button">+</button>
                                                       <button class="btn btn-outline-danger delete-photo-line font-weight-bold btn-sm ml-1" type="button">-</button>
                                                     </div>
                                               </div>
                                           </div>
                                              {% endfor %}
                                        {% endif %}
                              </div>

                              <div class="form-group">
                                <label for="commentaires">Commentaires et observations</label>
                                <textarea class="form-control" id="commentaires" name="commentaires" rows="3">{{ registre_origine.commentaires or '' }}</textarea>
                            </div>
                         </div>
                     </div>
                </div>

        <!-- Formulaire avec les elements d'identification -->
         <div class="card bg-light mb-3" style="max-width: 100rem;">
            <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#identification" aria-controls="identification">Modifier les éléments d'identification</div>
                <div class="collapse" id="identification">
                    <div class="card card-body">
                            <!-- Lieu et date passage -->
                            {% for lieu in registre_origine.lieuxDeclares %}
                                    <div class="form-row">
                                         {% if lieu.typeLieu =="Enregistrement" %}
                                             <div class="form-group col-md-6 required" >
                                                  <label for="lieuPassage">Lieu d'enregistrement administratif</label>
                                                  <div class="input-container-curiosity" id="idContainerLieuNormaliser{{loop.index}}">
                                                      <input autocomplete="off" type="text" class="form-control lieu-normalise-class input-field-curiosity" id="idLieuNormaliser{{loop.index}}" name="lieuPassage" value="{{ lieu.lieux.nomLieuFr }}, {{ lieu.lieux.departement }}, {{ lieu.lieux.pays }}, {{ lieu.lieux.id }}" onblur="myFunctionBlurFocus(value, id, {{loop.index}})">
                                                  </div>
                                              </div>
                                              <div class="form-group col-md-6 required" >
                                                 <label for="datePassage">Date d'enregistrement</label>
                                                 <input type="date" class="form-control" id="dataPassage" name="datePassage" value="{{ lieu.date }}" >
                                              </div>
                                         {% endif %}
                                    </div>
                             {% endfor %}
                            <!-- Nom Prénom-->
                            <div class="form-row">
                                  <!-- Nom -->
                                  <div class="form-group col-md-6">
                                    <label for="nom">Nom déclaré</label>
                                    <input type="text" class="form-control" id="nom" name="nom" maxlength="128" value="{{ registre_origine.nomOrigine or '' }}">
                                  </div>
                                   <!-- Prenom -->
                                  <div class="form-group col-md-6">
                                    <label for="prenom">Prénom déclaré</label>
                                    <input type="text" class="form-control" id="prenom" name="prenom" maxlength="128" value="{{ registre_origine.prenomOrigine or '' }}">
                                  </div>
                             </div>

                            <!--ID personne et Pseudonyme-->
                             <div class="form-row">
                                 <div class="form-group col-md-6">
                                    <label for="idPers">Identifiant de la personne</label>
                                    <input type="number" class="form-control" id="idPers" name="idPers"  value="{{ registre_origine.id_personne or '' }}">
                                  </div>
                                 <div class="form-group col-md-6">
                                    <label for="pseudo">Pseudonyme</label>
                                    <input type="text" class="form-control" id="pseudo" name="pseudo" maxlength="128" value="{{ registre_origine.pseudonyme or '' }}">
                                  </div>
                             </div>

                                <!--  Numéro d'ordre-->
                            <div class="form-row">
                                 <div class="form-group col-md-6">
                                    <label for="ordre">Numéro d'enregistrement ou nr d'ordre</label>
                                    <input type="text" class="form-control" id="ordre" name="ordre" maxlength="128" value="{{ registre_origine.nrOrdre or '' }}">
                                 </div>
                                  <div class="form-group col-md-6">
                                      <label for="index">Index registre origine</label>
                                      <input type="number" class="form-control" id="index" name="index" maxlength="6" value="{{ registre_origine.indexOrigine or '' }}">
                                  </div>
                            </div>
                    </div>
                </div>
         </div>

            <!-- Regroupement du formulaire par thématique -->

            <!-- Formulaire avec la description de la personne-->

            <div class="card bg-light mb-3" style="max-width: 100rem;">
                <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#champsPersonDescription" aria-controls="champsPersonDescription">Modifier les éléments de description générale de la personne</div>
                    <div class="collapse" id="champsPersonDescription">
                      <div class="card card-body">
                         <div class="form-row">
                             <div class="col-md-1"></div>
                                <!--taille-->
                              <div class="form-group">
                                <label for="taille">Taille de la personne</label>
                                <input type="text" class="form-control col-md-6" id="taille" name="taille" placeholder="ex : 1.62" value="{{ registre_origine.taillePersonne or '' }}">
                              </div>
                                <!--Age-->
                              <div class="form-group">
                                <label for="age">Age de la personne</label>
                                <input type="number" class="form-control col-md-6" id="age" name="age" value="{{ registre_origine.agePersonne or '' }}">
                              </div>
                            </div>
                           <div class="form-group">
                                <label for="duree">Durée du séjour</label>
                                <input type="text" class="form-control" id="duree" name="duree" maxlength="12" value="{{ registre_origine.dureeSejour or '' }}">
                              </div>

                          <!-- Autres caractéristiques-->
                          <div class="form-group">
                            <label for="autreCarr">Autres caractéristiques</label>
                            <input type="text" class="form-control" id="autreCarr" name="autreCarr" value="{{ registre_origine.autresCaracteristiques or '' }}">
                          </div>

                          <!-- description générales-->
                         <div class="form-group">
                            <label for="description">Description générale</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ registre_origine.description or '' }}</textarea>
                         </div>
                      </div>
                    </div>
            </div>

            <!-- Formulaire avec les métiers -->
             <div class="card bg-light mb-3" style="max-width: 100rem;">
              <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#champsPersonMetiers" aria-controls="champsPersonMetiers">Modifier les metiers de la personne</div>
                     <div class="collapse" id="champsPersonMetiers">
                         <div class="card card-body containerCatSouscat" id = "containerCatSouscat">

                             <!-- Metier déclaré-->
                          <div class="row">
                              <div class="form-group col-md-10">
                                    <label for="metier" class="font-weight-bold small">Métiers déclarés</label>
                                    <input type="text" class="form-control" id="metier" name="metier" maxlength="100" value="{{ registre_origine.professionOrigine or '' }}">
                              </div>
                          </div>

                             <!--Categorie et souscategories metiers-->
                          {% for lienCategorie in registre_origine.liensCategories %}
                                 <div class="new-link-div form-group row row-cols-1 row-cols-sm-2 row-cols-md-3">
                                     <!-- Categories-->
                                        <div class="form-group col-md-6" id="catSousCat{{loop.index}}"> <!-- loop.index permet de retrouver le numéro d'index de la boucle -->
                                          <label for="cat{{loop.index}}" class="font-weight-bold small">Selectionner une catégorie de métiers</label>
                                          <select class="custom-select my-1 mr-sm-2" id="cat{{loop.index}}" name="cat" onChange="generateSubCategory(value, {{loop.index}})">
                                                <option selected value="{{ lienCategorie.categories.labelCategorie }}">{{ lienCategorie.categories.labelCategorie }}</option> <!-- ajoute la catégorie d'origine-->
                                                 {% for objetCategorie in listeObjetscategories %} <!-- charge les objets catégories-->
                                                     {% if objetCategorie.labelCategorie != lienCategorie.categories.labelCategorie  %} <!-- condition pour ne pas doubler l'affichage de la catégorie d'origine-->
                                                    <option value ="{{objetCategorie.labelCategorie}}">{{objetCategorie.labelCategorie}}</option> <!-- ajoute les catégories restantes-->
                                                     {% endif %}
                                                 {% endfor %}
                                          </select>
                                        </div>

                                     <!-- Souscategories-->
                                        <div class="form-group col-md-5" id="divSousCat{{loop.index}}" {% if not lienCategorie.souscategories %} style="visibility: hidden" {% endif %}> <!-- si la catégorie ne contient pas de sous-catégories, chager la div des soucategories-->
                                            <label for="sousCat{{loop.index}}" class="font-weight-bold small">Ajouter une sous-catégorie</label>
                                            <select multiple class="form-control" id="sousCat{{loop.index}}" name="sousCat">
                                                <option selected value="{{ lienCategorie.souscategories.labelSouscategorie }}">{{ lienCategorie.souscategories.labelSouscategorie }}</option> <!-- ajoute la souscatégorie d'origine-->
                                            {% for objetCategorie in listeObjetscategories %}  <!-- charge les objets catégories-->
                                                {% if objetCategorie.labelCategorie == lienCategorie.categories.labelCategorie  %} <!-- Si le label de la catégorie chargé == avec le label de la catégorie chargée-->
                                                    {% for sousCat in objetCategorie.souscategories %} <!-- pour chaque sous-catégorie de la catégorie séléctionnée-->
                                                        {% if lienCategorie.souscategories.labelSouscategorie != sousCat.labelSouscategorie  %} <!-- condition pour ne pas doubler l'affichage de la souscatégories d'origine-->
                                                     <option value="{{ sousCat.labelSouscategorie }}">{{ sousCat.labelSouscategorie }}</option> <!-- ajoute les souscatégories restantes-->{% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                            <option>aucune</option>
                                            </select>
                                        </div>

                                      <!-- Bouttons-->
                                      <div class="col-1">
                                         <div class="input-group-append mt-4 pt-1">
                                            <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2 mb-2 ml-2" type="button">-</button>
                                         </div>
                                      </div>
                                 </div>


                          {% endfor%}

                          <!-- Boutton Ajouter une catégorie -->
                          <div class="form-row">
                                    <div class="col-sm">
                                        <div class="input-group-append">
                                          <button class="btn btn-outline-success add-new-line font-weight-bold btn-sm mt-2 mb-2" type="button">Ajouter une catégorie</button>
                                          <!-- <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2" type="button">Supprimer une catégorie</button> -->
                                        </div>
                                    </div>
                          </div>
                         </div>
                     </div>
             </div>

             <!-- Formulaire avec les caractéristiques physiques-->
             <div class="card bg-light mb-3" style="max-width: 100rem;">
                  <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#caracterisquesPhysiques" aria-controls="caracterisquesPhysiques">Modifier les caractéristiques physiques de la personne</div>
                 <div class="collapse" id="caracterisquesPhysiques">
                      <div class="card card-body">
                         <div class="container-fluid">
                             <div class="form-group col-md-12">
                                <label for="carrPhys">Description des caractéristiques physiques</label>
                                <input type="text" class="form-control" id="carrPhys" name="carrPhys" value="{{ registre_origine.caracteristiquesPhysiques or '' }}">
                             </div>
                                {% for caracteristique in caracteristiquesPysiques %}
                                        <div class="form-group col-md-12">
                                              <label class="form-check">
                                                  <input type="checkbox" class="form-check-input" name="physique" value="{{caracteristique[0]}}"
                                                  {% for physiqueChecked in registre_origine.caracteristiques %}
                                                      {% if physiqueChecked.labelCaracteristique == caracteristique[0] %}
                                                      checked
                                                      {% endif %}
                                                  {% endfor %}
                                                  >{{caracteristique[0]}}
                                              </label>
                                        </div>
                                {% endfor %}
                        </div>
                      </div>
                 </div>
             </div>

             <!-- Formulaire avec l'accompagné par-->
             <div class="card bg-light mb-3" style="max-width: 100rem;">
                 <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#champsVoyageAvec" aria-controls="champsVoyageAvec">Modifier les éléments sur les personnes d'accompagnement</div>
                 <div class="collapse" id="champsVoyageAvec">
                      <div class="card card-body" id="containerVoyageAvec">
                          <div class="form-group">
                                <label for="accompagnePar">Accompagné par</label>
                                <input type="text" class="form-control" id="accompagnePar" name="accompagnePar" value="{{ registre_origine.accompagnePar or '' }}">
                          </div>
                              <div class="form-check mb-3">
                                    <label class="form-check-label">
                                    <input class="form-check-input" type="checkbox" name="epoux"
                                           {% if registre_origine.epoux==1 %}
                                           checked
                                            {% endif %}
                                   value="1" > Epoux/épouse
                                    </label><!-- Si on check la valeur par défaut est 1, sinon, c'est None-->
                              </div>

                          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3">
                              <div class="form-group col-4">
                                    <label for="nbEnfants">Enfants (nombre)</label>
                                    <input type="number" class="form-control" id="nbEnfants" name="nbEnfants" value="{{ registre_origine.nbEnfants or '' }}">
                              </div>
                              <div class="form-group col-4">
                                    <label for="nbAutreMembre">Autres membre de la famille (nombre)</label>
                                    <input type="number" class="form-control" id="nbAutreMembre" name="nbAutreMembre" value="{{ registre_origine.nbAutreMembre or '' }}">
                              </div>
                               <div class="form-group col-4">
                                    <label for="nbAutrePers">Autres personnes (nombre)</label>
                                    <input type="number" class="form-control" id="nbAutrePers" name="nbAutrePers" value="{{ registre_origine.nbPersSupplement or '' }}">
                              </div>
                           </div>
                          <div class="form-group row row-cols-1">
                               <div class="col-10">
                                   <label for="voyageAvecIdPers">Voyage avec ... (l'identifiant de la personne)</label>
                               </div>
                           </div>
                      {% if registre_origine.voyageAvecRegistre %}
                            {% for personne in registre_origine.voyageAvecRegistre %}
                              <div class="new-link-div row row-cols-1 mb-2">
                                  <div class="col-4">
                                      <input type="number" class="form-control" id="voyageAvecIdPers" name="voyageAvecIdPers" value="{{ personne.id_personne or '' }}">
                                  </div>
                                 <!-- Boutton + et - -->
                                  <div class="col-1">
                                      <div class="input-group-append">
                                          <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2 mb-2 ml-1" type="button">-</button>
                                      </div>
                                  </div>
                              </div>
                            {% endfor %}
                      {% endif %}
                          <div class="col-10 mb-3">
                               <button class="btn btn-outline-success add-new-line font-weight-bold btn-sm" type="button">Ajouter un identifiant de personne</button>
                            </div>
                      </div>
                 </div>
             </div>

             <!-- Formulaire avec les déplacements-->

             <div class="card bg-light mb-3" style="max-width: 100rem;">
                  <div class="card-header_curiosity collapsed" data-toggle="collapse" href="#DateAndMouvement" aria-controls="DateAndMouvement">Modifier les lieux et les dates de passage de la personne</div>
                  <div class="collapse" id="DateAndMouvement">
                        <div class="card card-body containerLieuxDelares" id="containerLieuxDelares">
                         <div class="form-group row row-cols-1 row-cols-sm-2 row-cols-md-4">
                             <div class="col-3 required"><label for="listeTypeLieu">Type de lieu</label></div>
                             <div class="col-3"><label for="listeLieuDeclare">Lieu déclaré</label></div>
                             <div class="col-3"><label for="listeLieuNormal">Lieu normalisé</label></div>
                             <div class="col-3"><label for="listeDates">Date</label></div>
                         </div>
                        {% if registre_origine.lieuxDeclares %}
                              {% for lieu in registre_origine.lieuxDeclares %}
                                  {% if lieu.typeLieu !="Enregistrement" %} <!-- élimine le type de lieu enregistrement qui a été rajouté avant-->
                                      <div class="new-link-div form-group row row-cols-1 row-cols-sm-2 row-cols-md-5">
                                      <div class="col-3">
                                            <select class="custom-select form-control" id="listeTypeLieu" name="listeTypeLieu" required>
                                                    <option value="{{ lieu.typeLieu or '' }}">{{ lieu.typeLieu or '' }}</option> <!-- ajoute le type de lieu saisis à l'origine-->
                                                    {% for lieuType in listeTypeLieux %} <!--listeTypeLieux passée au html depuis une liste en dur-->
                                                        {% if lieu.typeLieu != lieuType  %} <!-- condition pour ne pas doubler l'affichage les types de lieux d'origine-->
                                                        <option value = "{{ lieuType }}">{{lieuType}}</option> <!-- ajoute les types de lieux restants-->
                                                        {% endif %}
                                                    {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <input type="text" class="form-control" id="listeLieuDeclare" placeholder="ex : Duché de Parme" name="listeLieuDeclare" value="{{ lieu.labelLieuDeclare or '' }}">
                                        </div>
                                        <div class="col-3 input-container-curiosity" id="idContainerLieuNormaliser{{loop.index}}">
                                        <!--  l'attribut value de l'input sera vide si le lieu normalisé n'existe pas; sans cette condition, on a ,,,-->
                                            <input type="text" class="form-control lieu-normalise-class input-field-curiosity" id="idLieuNormaliser{{loop.index}}" name="listeLieuNormal"
                                                    {% if lieu.lieux.nomLieuFr %}
                                                       value="{{ lieu.lieux.nomLieuFr}}, {{lieu.lieux.departement or ''}}, {{lieu.lieux.pays or ''}}, {{lieu.lieux.id|string }}"
                                                    {% endif %}
                                                   onblur="myFunctionBlurFocus(value, id, {{loop.index}} )">
                                        </div>
                                        <div class="col-2">
                                            <input type="date" class="form-control" id="listeDates" name="listeDates" value="{{ lieu.date or '' }}">
                                        </div>
                                        <div class="col-1">
                                             <div class="input-group-append">
                                                <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2 mb-2 ml-2" type="button">-</button>
                                             </div>
                                        </div>
                                      </div>
                                  {% endif %}
                              {% endfor %}
                        {% endif %}
                          <div class="col-10 mb-3">
                              <div class="input-group-append">
                                  <div class="input-group-append">
                                      <button class="btn btn-outline-success add-new-line font-weight-bold btn-sm" type="button">Ajouter un lieu</button>
                                  </div>
                              </div>
                          </div>
                        </div>
                  </div>
             </div>

             <button type="submit" class="btn btn-primary">Modifier registre</button>
        </form>

      {% block scripts %}

           <script>

            //PHOTOS. FONCTION QUI PERMET DE GENERER DES LIGNES AVEC INPUT PHOTOS
             $(document).ready(function() {
                 $("#containerPhotos").on("click", ".add-new-photo", function (event) {
                    event.preventDefault();

                    var lignenewphoto = `<div class="photo-link-div form-group row">
                                       <div class="col-3">
                                            <input type="text" class="form-control" id="photo" maxlength="64" name="photo" placeholder="ex : AM_Agen_2i20_7386">
                                       </div>
                                       <div class="col-1">
                                             <div class="input-group-append">
                                               <button class="btn btn-outline-success add-new-photo font-weight-bold btn-sm" type="button">+</button>
                                               <button class="btn btn-outline-danger delete-photo-line font-weight-bold btn-sm ml-1" type="button">-</button>
                                             </div>
                                       </div>
                                  </div> `;


                    $("#containerPhotos").append($(lignenewphoto));
                        });

                    $("#containerPhotos").on("click", ".delete-photo-line", function (event) {
                        event.preventDefault();
                        var current = $(this),
                            parent  = current.parents(".photo-link-div");
                            parent.remove();
                            });

                   });


              //FONCTION QUI PERMET DE GÉNÉRER LES SOUSCATEGORIES EN FCT DE LA CATÉGORIE CHOISIE
              // la fonction prend deux attributs: la valeur de <option> et un numero
                function generateSubCategory(value, nbClick) {
                    //récupération de l'élement HTML <div> pour les soucategories (qui contient la balise label et la balise select)
                    var divSousCat = document.getElementById("divSousCat"+nbClick);

                    //récupération de l'élement HTML <Select> pour les soucategories
                    var sousCat = document.getElementById("sousCat"+nbClick);

                    // cacher la div qui contient les souscategories (la balise label et la balise select)
                    divSousCat.style.visibility = "hidden";

                    // supprimer le contenu du select dans souscategories (dans le cas où l'on change de catégorie au sein du même composant "catégorie")
                    sousCat.options.length = 0;

                    //Ajout de l'option Choisir dans les souscatégories systématiquement
                    var option = document.createElement("option");
                    option.text ='aucune'
                    sousCat.add(option);

                    {% for objetCategorie in listeObjetscategories %}
                        if (value === "{{ objetCategorie.labelCategorie | safe }}") {
                            {% for sousCat in objetCategorie.souscategories %}
                                // on rend visible la div des souscatégories
                                divSousCat.style.visibility = "visible";
                                // creation de la balise <option> pour les souscategories
                                option = document.createElement("option");
                                // on attribue à <option> le libellé de la souscategorie
                                option.text = "{{sousCat.labelSouscategorie | safe }}";
                                // on ajoute la balise option dans <select>
                                sousCat.add(option);
                            {% endfor %}
                        }
                    {% endfor %}

                // sélectionne par défaut le premier élement de la liste de souscatégories (choisir...).
                    sousCat.selectedIndex = "0";
                }

                // MULTIPLIER LES LIGNES DES METIERS -->
                nbCategorie = parseInt({{ registre_origine.liensCategories|length }}); // recupère le nombre de catégories déja affichées
                nBclick = nbCategorie;
                $(document).ready(function() {
                 $("#containerCatSouscat").on("click", ".add-new-line", function (event) {
                    event.preventDefault();
                    nBclick =nBclick +1;  // ajoute au nombre de catégories déja affichées pour générer l'id
                    var new_element = ` <div class="new-link-div form-group row row-cols-1 row-cols-sm-2 row-cols-md-3">
                                            <div class="form-group col-md-6" id="catSousCat`+ nBclick+`">
                                              <label class="font-weight-bold small" for="cat`+ nBclick+`">Selectionner une catégorie de métiers</label>
                                              <select class="custom-select my-1 mr-sm-2" id="cat`+ nBclick+`" name="cat" onChange="generateSubCategory(value,`+ nBclick+`)">
                                                    <option selected>aucune</option>
                                                    {% for objetCategorie in listeObjetscategories %}
                                                       <option value ="{{objetCategorie.labelCategorie}}">{{objetCategorie.labelCategorie}}</option>
                                                    {% endfor %}
                                              </select>
                                            </div>
                                    <div class="form-group col-md-5" id="divSousCat`+ nBclick+`" style="visibility: hidden">
                                        <label for="sousCat`+ nBclick+`" class="font-weight-bold small">Ajouter une sous-catégorie</label>
                                        <select multiple class="form-control" id="sousCat`+ nBclick+`" name="sousCat">
                                        </select>
                                    </div>
                                      <div class="col-1">
                                        <div class="input-group-append mt-4 pt-1">
                                          <button class="btn btn-outline-success add-new-line font-weight-bold btn-sm mt-2 mb-3 " type="button">+</button>
                                          <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2 mb-3 ml-3" type="button">-</button>
                                        </div>
                                     </div>
                           </div>`;
                 $("#containerCatSouscat").append($(new_element));
                 });
                 $("#containerCatSouscat").on("click", ".delete-current-line", function (event) {
                    event.preventDefault();
                    var current = $(this),
                        parent  = current.parents(".new-link-div");
                        parent.remove();
                 });
                });

                <!-- MULTIPLIER LES LIGNES POUR VOYAGE AVEC -->
                $(document).ready(function() {
                 $("#containerVoyageAvec").on("click", ".add-new-line", function (event) {
                    event.preventDefault();
                    var new_element = `
                              <div class="new-link-div row row-cols-1 mb-2">
                                  <div class="col-4"><input type="number" class="form-control" name="voyageAvecIdPers" placeholder="ex : 875"></div>
                                  <div class="col-2"><div class="input-group-append">
                                  <button class="btn btn-outline-success add-new-line font-weight-bold btn-sm mt-2 mb-2" type="button">+</button>
                                  <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2 mb-2 ml-2" type="button">-</button>
                                  </div>
                                  </div>
                              </div>
                          {{ typeDocument }}
                    `;
                    $("#containerVoyageAvec").append($(new_element));
                    });
                 $("#containerVoyageAvec").on("click", ".delete-current-line", function (event) {
                    event.preventDefault();
                    var current = $(this),
                        parent  = current.parents(".new-link-div");
                        parent.remove();
                 });
                });

              <!-- MULTIPLIER LES LIGNES DES LIEUX DECLARES -->
                  // Etablit le numero du lieu en fonction de la taille de la liste des lieux déclarés chargés
                  nBLieux = parseInt({{ registre_origine.lieuxDeclares|length }});
                  nBNewLieu=nBLieux;

                  $(document).ready(function() {
                     $("#containerLieuxDelares").on("click", ".add-new-line", function (event) {
                        event.preventDefault();
                        nBNewLieu = nBNewLieu+1;
                        var new_element = `
                             <div class="new-link-div form-group row row-cols-1 row-cols-sm-2 row-cols-md-5">
                                  <div class="col-3"><select class="custom-select " name="listeTypeLieu" required>
                                                  <option selected></option>
                                                  <option value = "Naissance">Naissance</option>
                                                  <option value = "Domicile">Domicile</option>
                                                  <option value = "Délivrance du passeport">Délivrance du passeport</option>
                                                  <option value = "Dernier Passage">Dernier Passage</option>
                                                  <option value = "Destination">Destination</option>
                                                  <option value = "Visa">Visa</option>
                                                  <option value = "Décès">Décès</option>
                                             </select>
                                  </div>
                                  <div class="col-3"><input type="text" class="form-control" name="listeLieuDeclare" placeholder="ex : Duché de Parme"></div>
                                  <div class="col-3 input-container-curiosity" id ="idContainerLieuNormaliser`+nBNewLieu+`"><input type="text" class="form-control lieu-normalise-class" id="idLieuNormaliser`+nBNewLieu+`" name="listeLieuNormal" placeholder="ex : Parme" onblur="myFunctionBlurFocus(value,id, `+nBNewLieu+`,)"></div>
                                  <div class="col-2"><input type="date" class="form-control" id="listeDates" name="listeDates"></div>
                                  <div class="col-1"><div class="input-group-append">
                                         <button class="btn btn-outline-success add-new-line font-weight-bold btn-sm mt-2 mb-2" type="button">+</button>
                                         <button class="btn btn-outline-danger delete-current-line font-weight-bold btn-sm mt-2 mb-2 ml-2" type="button">-</button>
                                         </div>
                                  </div>
                             </div>`;

                        $("#containerLieuxDelares").append($(new_element));

                        autocompleMultiple(".lieu-normalise-class", tagsLieux);
                     });
                     $("#containerLieuxDelares").on("click", ".delete-current-line", function (event) {
                        event.preventDefault();
                        var current = $(this),
                            parent  = current.parents(".new-link-div");
                            parent.remove();
                     });
                    });

                    var tagsLieux = {{ lieux|safe }}

                    autocompleMultiple(".lieu-normalise-class", tagsLieux);


                autocompleMultiple("#typeDoc", {{ typeDocument|safe}});

                autocompleMultiple("#archive", {{ listeNomsArchive|safe }});


              // fonction qui appelle ma fonction removeValueWhenIncorrectPlace pour ajouter une icone et supprimer la saisie si le lieu n'est pas dans la liste de l'autocomplete
               function myFunctionBlurFocus(valeur, idInput, numbreLoop) {

                   removeValueWhenIncorrectPlace(tagsLieux, valeur, idInput, "idContainerLieuNormaliser"+numbreLoop);
               }

                removeEnterSubmit ("modificationFormId");

    //MODAL: FONCTIONS QUI PERMETENT DE CREER DES LIEUX DANS LA BASE DE DONNEES

     // ma fonction pour afficher la carte leaflet sans erreurs
      displayMapInModal("myModalPlace");
      </script>
            {% include "includes/map.html" %}
      <script>

    //generate map
    var theMarker = {};

     // implement autocomplete avec les lieux de Geonames
    $('#nomLieu').autocomplete({

    // Appel http geonames avec la fonction ajax
    source : function(requete, reponse){ // les deux arguments représentent les données nécessaires au plugin

	  $.ajax({
            url : 'https://secure.geonames.org/searchJSON', // on appelle le script JSON
            dataType : 'json', // on spécifie bien que le type de données est en JSON
            data : {
                name_startsWith : requete.term, // on donne la chaîne de caractère tapée dans le champ de recherche Nom lieu
                {% if current_user.username_geoname != "" %}
                username : '{{ current_user.username_geoname|safe }}', // à remplacer par un username enregistré dans la base
                {% endif %}
                maxRows : 100, // nr d'éléments affichés
                lang : 'fr' // param lang pour avoir la version des noms en fr
            },

            success : function(donnee){
                reponse($.map(donnee.geonames, function(item){
                    return {
                      label: item.name + (item.adminName1 ? ", " + item.adminName1 : "") + ", " + item.countryCode +", " + item.fclName, // affiche les 4 éléments: lieu, region, code pays et type lieu. Pour le département il y a une condition
                                    // (item.adminName1 ? ", " + item.adminName1 : "") : si item.adminName1 (?) alors ","+ item.adminName1, sinon (:)  ""
						value: item.name,
                        lat: item.lat,
                        lng: item.lng,
                        pays: item.countryName,
                        region: item.adminName1,
                      geonameId : item.geonameId
                    }
                }));
            }
        });
    },
        select : function(event, ui){ // lors de la sélection d'une proposition on rajoute dans les inputs automatiquement
        $( '#lat' ).val( ui.item.lat );
        $( '#lng' ).val( ui.item.lng);
        $( '#pays' ).val( ui.item.pays);
        $( '#region' ).val( ui.item.region);
        $( '#idGeonames' ).val( ui.item.geonameId);
        regenerateMap(ui.item.lat, ui.item.lng)
    }
        });

   function updateMap() { // appliqué à l'événement onchange sur latitude et longitude
       var lat = document.getElementById("lat");
       var lng = document.getElementById("lng");
       regenerateMap(lat.value, lng.value) // les paramètres de la fonction représente la valeur de long et lat, pas les balises html long et lat
   }

   function regenerateMap (lat, long) {
       mymap.setView([lat, long], 10); // setView: objet de Leaflet qui fixe la vue de la carte sur la lat et lonf
       if (theMarker != undefined) { // si le marqueur est différent de null (car la première fois il n'existe pas)
           mymap.removeLayer(theMarker); //removeLayer:objet leaflet. supprime l'ancien marqueur de la carte
       };
       theMarker = L.marker([lat,long]).addTo(mymap); // L.marker: construot un nouveau marquer et l'ajoute à la carte
   }

   // vider le formulaire quand on ferme le modal
   $("#closeModal").click(function () {
       $("#creationPlaceFormId")[0].reset();
        $("#successAlert").hide(); // cache le message de succes de la creation du lieu
               $("#errorAlert").hide() // cache le message d'erreur de la creation du lieu
   })

   // send the form to the bdd. On click sur le boutton Sauvegarder
   $("#idBtnSavePlace").click(function () {
                // récupère dans un objet de type dictionaire
               var body = { "nomLieu": $("#nomLieu").val(),
                           "pays": $("#pays").val(),
                           "region": $("#region").val(),
                           "depart": $("#depart").val(),
                           "lat": $("#lat").val(),
                           "lng": $("#lng").val(),
                           "codeINSEE": $("#codeINSEE").val(),
                           "idGeonames": $("#idGeonames").val()};
               //initialise un appel HTTP avec la methode post
               $.ajax(
                   {
                       url: "{{url_for("savePlace")}}", //l'url de la route défini dans flask
                       type:"POST",
                       dataType: 'json', // format des données envoyées
                       contentType: "application/json", // format des données envoyées
                       data: JSON.stringify(body), //transorme l'objet body dans un objet json
                      //si le retour est "success"
                       success: function (retourHttp) { //le retour serveur (avec 4 parametres) est utilisé dans la variable retourHttp
                           if (retourHttp.codeRetour==="OK"){ // codeRetour est la deuxième variable de la methode json_response déclaré coté serveur.
                                //mettre à jour la liste des lieux coté client pour l'autocomplete
                               tagsLieux.push(retourHttp.nouveauLieuComplet); // nouveauLieuComplet: la quatrieme variable de la methode json_response
                                $("#successAlert").text(retourHttp.message).show(); // affiche à l'ecran le message de succes de la creation du lieu
                                $("#errorAlert").hide() // cahche la div qui affiche l'erreur
                           }
                           else { // Si le code n'est pas "OK"
                                $("#errorAlert").text(retourHttp.message).show(); // affiche le message d'erreur dans la balise div associée avec l'erreur
                                $("#successAlert").hide();
                           }
                           },
                       // si le retour est error ou echec, affiche un message 404
                        error : function (retourHttp) {
                                $("#errorAlert").text(retourHttp.message).show();
                                $("#successAlert").hide();
                           }
                   });
           })
 shadeButtonSubmit ()

  </script>
     {% endblock %}

{% endblock %}